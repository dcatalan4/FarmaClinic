@using ControlInventario.Helpers
@model IEnumerable<ControlInventario.Models.Producto>
@{
    ViewData["Title"] = "Inventario - Vista Lector";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes"></i> Inventario Completo
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" id="busquedaRapida" class="form-control" placeholder="Buscar producto por código, nombre o descripción..." autocomplete="off">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarRapido()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="sugerencias" class="mt-1" style="position: relative; z-index: 1000;"></div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="inventarioTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Precio Venta</th>
                                    <th>Stock Actual</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.Codigo</td>
                                        <td>@item.Nombre</td>
                                        <td>@item.Descripcion</td>
                                        <td>@CurrencyHelper.ToQuetzales(item.PrecioVenta)</td>
                                        <td>
                                            <span class="badge @(item.StockActual > 10 ? "bg-success" : item.StockActual > 0 ? "bg-warning" : "bg-danger")">
                                                @item.StockActual
                                            </span>
                                        </td>
                                        <td>
                                            @if (item.Activo)
                                            {
                                                <span class="badge bg-success">Activo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inactivo</span>
                                            }
                                        </td>
                                        <td>
                                            <a href="@Url.Action("Details", new { id = item.IdProducto })" class="btn btn-sm btn-info" title="Ver Detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("Movimientos", new { id = item.IdProducto })" class="btn btn-sm btn-secondary" title="Ver Movimientos">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let searchTimeout;

        // Inicializar el buscador
        document.addEventListener('DOMContentLoaded', function() {
            const buscador = document.getElementById('busquedaRapida');
            const sugerenciasDiv = document.getElementById('sugerencias');
            
            if (!buscador) return;

            // Evento de input para autocompletado
            buscador.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const term = this.value.trim();
                
                if (term.length < 2) {
                    sugerenciasDiv.innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    buscarProductos(term);
                }, 300);
            });

            // Evento focus para mostrar sugerencias
            buscador.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    buscarProductos(this.value.trim());
                }
            });

            // Cerrar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!buscador.contains(e.target) && !sugerenciasDiv.contains(e.target)) {
                    sugerenciasDiv.innerHTML = '';
                }
            });

            // Evento Enter para buscar
            buscador.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarRapido();
                }
            });
        });

        // Función para buscar productos via AJAX
        async function buscarProductos(term) {
            try {
                const response = await fetch(`/InventarioLector/BuscarProductos?term=${encodeURIComponent(term)}`);
                const productos = await response.json();
                
                const sugerenciasDiv = document.getElementById('sugerencias');
                
                if (productos.length > 0) {
                    let html = '<div class="list-group" style="position: absolute; width: 100%; max-height: 200px; overflow-y: auto; z-index: 1000;">';
                    
                    productos.forEach(producto => {
                        const nombreEscapado = (producto.nombre || '').replace(/'/g, "\\'");
                        const descripcionCorta = producto.descripcion ? 
                            (producto.descripcion.length > 50 ? producto.descripcion.substring(0, 50) + '...' : producto.descripcion) : 
                            'Sin descripción';
                        
                        html += `
                            <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarProducto('${producto.codigo}', '${nombreEscapado}')">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${producto.codigo} - ${producto.nombre}</h6>
                                    <small class="text-muted">Q ${producto.precioVenta.toFixed(2)}</small>
                                </div>
                                <p class="mb-1 text-muted small">${descripcionCorta}</p>
                                <small class="text-muted">Stock: ${producto.stock}</small>
                            </a>
                        `;
                    });
                    
                    html += '</div>';
                    sugerenciasDiv.innerHTML = html;
                } else {
                    sugerenciasDiv.innerHTML = '<div class="alert alert-info py-2">No se encontraron productos</div>';
                }
            } catch (error) {
                console.error('Error al buscar productos:', error);
                document.getElementById('sugerencias').innerHTML = '<div class="alert alert-danger py-2">Error al buscar productos</div>';
            }
        }

        // Función para seleccionar un producto del autocompletado
        function seleccionarProducto(codigo, nombre) {
            document.getElementById('busquedaRapida').value = codigo + ' - ' + nombre;
            document.getElementById('sugerencias').innerHTML = '';
            buscarRapido();
        }

        // Función para filtrar la tabla (botón lupa)
        function buscarRapido() {
            const termino = document.getElementById('busquedaRapida').value.trim().toLowerCase();
            
            if (termino === '') {
                mostrarTodos();
                return;
            }
            
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            let encontrados = 0;
            
            filas.forEach(function(fila) {
                const texto = fila.textContent.toLowerCase();
                if (texto.includes(termino)) {
                    fila.style.display = '';
                    encontrados++;
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Ocultar sugerencias
            document.getElementById('sugerencias').innerHTML = '';
            
            // Mostrar mensaje si no hay resultados
            if (encontrados === 0) {
                mostrarMensajeSinResultados();
            } else {
                ocultarMensajeSinResultados();
            }
        }

        // Función para mostrar todos los productos
        function mostrarTodos() {
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            filas.forEach(function(fila) {
                fila.style.display = '';
            });
            ocultarMensajeSinResultados();
        }

        // Función para mostrar mensaje sin resultados
        function mostrarMensajeSinResultados() {
            let mensajeDiv = document.getElementById('mensajeSinResultados');
            if (!mensajeDiv) {
                mensajeDiv = document.createElement('div');
                mensajeDiv.id = 'mensajeSinResultados';
                mensajeDiv.className = 'alert alert-warning mt-3';
                mensajeDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No se encontraron productos que coincidan con la búsqueda.';
                document.querySelector('#inventarioTable').parentNode.insertBefore(mensajeDiv, document.querySelector('#inventarioTable').nextSibling);
            }
        }

        // Función para ocultar mensaje sin resultados
        function ocultarMensajeSinResultados() {
            const mensajeDiv = document.getElementById('mensajeSinResultados');
            if (mensajeDiv) {
                mensajeDiv.remove();
            }
        }

        // Función para limpiar búsqueda
        function limpiarBusqueda() {
            document.getElementById('busquedaRapida').value = '';
            document.getElementById('sugerencias').innerHTML = '';
            mostrarTodos();
        }
    </script>
}
