@model IEnumerable<ControlInventario.Models.Producto>
@{
    ViewData["Title"] = "Inventario - Vista Lector";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes"></i> Inventario Completo
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" id="busquedaRapida" class="form-control" placeholder="Buscar producto..." autocomplete="off">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarRapido()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="sugerencias" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="inventarioTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Precio Venta</th>
                                    <th>Stock Actual</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.Codigo</td>
                                        <td>@item.Nombre</td>
                                        <td>@item.Descripcion</td>
                                        <td>@item.PrecioVenta.ToString("C")</td>
                                        <td>
                                            <span class="badge @(item.StockActual > 10 ? "bg-success" : item.StockActual > 0 ? "bg-warning" : "bg-danger")">
                                                @item.StockActual
                                            </span>
                                        </td>
                                        <td>
                                            @if (item.Activo)
                                            {
                                                <span class="badge bg-success">Activo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inactivo</span>
                                            }
                                        </td>
                                        <td>
                                            <a href="@Url.Action("Details", new { id = item.IdProducto })" class="btn btn-sm btn-info" title="Ver Detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("Movimientos", new { id = item.IdProducto })" class="btn btn-sm btn-secondary" title="Ver Movimientos">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Datos de productos para autocompletar
        const productos = @Html.Raw(Json.Serialize(Model.Select(p => new { p.IdProducto, p.Codigo, p.Nombre, p.Descripcion })));
        
        function buscarRapido() {
            const termino = document.getElementById('busquedaRapida').value.trim();
            if (termino === '') {
                mostrarTodos();
                return;
            }
            
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            filas.forEach(function(fila) {
                const texto = fila.textContent.toLowerCase();
                if (texto.includes(termino.toLowerCase())) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Ocultar sugerencias al buscar
            document.getElementById('sugerencias').style.display = 'none';
        }
        
        function mostrarTodos() {
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            filas.forEach(function(fila) {
                fila.style.display = '';
            });
        }
        
        function mostrarSugerencias(termino) {
            const sugerenciasDiv = document.getElementById('sugerencias');
            
            if (termino.length < 2) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            const filtrados = productos.filter(p => 
                p.Codigo.toLowerCase().includes(termino.toLowerCase()) ||
                p.Nombre.toLowerCase().includes(termino.toLowerCase()) ||
                (p.Descripcion && p.Descripcion.toLowerCase().includes(termino.toLowerCase()))
            ).slice(0, 5);
            
            if (filtrados.length === 0) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            filtrados.forEach(p => {
                html += `
                    <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarProducto('${p.Codigo}', '${p.Nombre.replace(/'/g, "\\'")}')">
                        <strong>${p.Codigo}</strong> - ${p.Nombre}
                    </a>
                `;
            });
            
            sugerenciasDiv.innerHTML = html;
            sugerenciasDiv.style.display = 'block';
        }
        
        function seleccionarProducto(codigo, nombre) {
            document.getElementById('busquedaRapida').value = codigo + ' - ' + nombre;
            document.getElementById('sugerencias').style.display = 'none';
            buscarRapido();
        }
        
        // Event listeners
        document.getElementById('busquedaRapida').addEventListener('input', function(e) {
            mostrarSugerencias(e.target.value);
        });
        
        document.getElementById('busquedaRapida').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarRapido();
            }
        });
        
        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#busquedaRapida') && !e.target.closest('#sugerencias')) {
                document.getElementById('sugerencias').style.display = 'none';
            }
        });
    </script>
}
