@using ControlInventario.Helpers
@model IEnumerable<ControlInventario.Models.Producto>
@{
    ViewData["Title"] = "Inventario - Vista Lector";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-boxes"></i> Inventario Completo
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="input-group">
                                <input type="text" id="busquedaRapida" class="form-control" placeholder="Buscar producto por código, nombre o descripción..." autocomplete="off">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarRapido()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="sugerencias" class="list-group position-absolute shadow-lg" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto; border-radius: 0.375rem;"></div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="inventarioTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Precio Venta</th>
                                    <th>Stock Actual</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>@item.Codigo</td>
                                        <td>@item.Nombre</td>
                                        <td>@item.Descripcion</td>
                                        <td>@CurrencyHelper.ToQuetzales(item.PrecioVenta)</td>
                                        <td>
                                            <span class="badge @(item.StockActual > 10 ? "bg-success" : item.StockActual > 0 ? "bg-warning" : "bg-danger")">
                                                @item.StockActual
                                            </span>
                                        </td>
                                        <td>
                                            @if (item.Activo)
                                            {
                                                <span class="badge bg-success">Activo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inactivo</span>
                                            }
                                        </td>
                                        <td>
                                            <a href="@Url.Action("Details", new { id = item.IdProducto })" class="btn btn-sm btn-info" title="Ver Detalles">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("Movimientos", new { id = item.IdProducto })" class="btn btn-sm btn-secondary" title="Ver Movimientos">
                                                <i class="fas fa-history"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Datos de productos para autocompletar
        let productos = [];
        
        try {
            productos = @Html.Raw(Json.Serialize(Model.Select(p => new { 
                p.IdProducto, 
                p.Codigo, 
                p.Nombre, 
                Descripcion = p.Descripcion ?? "" 
            })));
            console.log('Productos cargados:', productos.length);
        } catch (error) {
            console.error('Error al cargar productos:', error);
            productos = [];
        }
        
        let indiceSugerenciaSeleccionado = -1;
        
        function seleccionarProducto(codigo, nombre) {
            document.getElementById('busquedaRapida').value = codigo + ' - ' + nombre;
            document.getElementById('sugerencias').style.display = 'none';
            buscarRapida();
        }
        
        function buscarRapida() {
            const termino = document.getElementById('busquedaRapida').value.trim();
            if (termino === '') {
                mostrarTodos();
                return;
            }
            
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            filas.forEach(function(fila) {
                const texto = fila.textContent.toLowerCase();
                if (texto.includes(termino.toLowerCase())) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
            
            // Ocultar sugerencias al buscar
            document.getElementById('sugerencias').style.display = 'none';
        }
        
        function mostrarTodos() {
            const filas = document.querySelectorAll('#inventarioTable tbody tr');
            filas.forEach(function(fila) {
                fila.style.display = '';
            });
        }
        
        function mostrarSugerencias(termino) {
            console.log('Mostrando sugerencias para:', termino);
            const sugerenciasDiv = document.getElementById('sugerencias');
            
            if (termino.length < 2) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            const filtrados = productos.filter(p => {
                const codigo = (p.Codigo || '').toString().toLowerCase();
                const nombre = (p.Nombre || '').toString().toLowerCase();
                const descripcion = (p.Descripcion || '').toString().toLowerCase();
                
                return codigo.includes(termino.toLowerCase()) ||
                       nombre.includes(termino.toLowerCase()) ||
                       descripcion.includes(termino.toLowerCase());
            }).slice(0, 5);
            
            console.log('Productos filtrados:', filtrados.length);
            
            if (filtrados.length === 0) {
                sugerenciasDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            filtrados.forEach(p => {
                const descripcionCorta = p.Descripcion ? (p.Descripcion.length > 50 ? p.Descripcion.substring(0, 50) + '...' : p.Descripcion) : '';
                html += `
                    <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarProducto('${p.Codigo || ''}', '${(p.Nombre || '').replace(/'/g, "\\'")}')">
                        <div class="d-flex w-100 justify-content-between">
                            <div>
                                <strong>${p.Codigo || ''}</strong> - ${p.Nombre || ''}
                                ${descripcionCorta ? `<br><small class="text-muted">${descripcionCorta}</small>` : ''}
                            </div>
                            <small class="text-primary">Click para seleccionar</small>
                        </div>
                    </a>
                `;
            });
            
            sugerenciasDiv.innerHTML = html;
            sugerenciasDiv.style.display = 'block';
            console.log('Sugerencias mostradas');
        }
        
        // Event listeners
        document.getElementById('busquedaRapida').addEventListener('input', function(e) {
            console.log('Input event:', e.target.value);
            indiceSugerenciaSeleccionado = -1;
            mostrarSugerencias(e.target.value);
        });
        
        document.getElementById('busquedaRapida').addEventListener('keydown', function(e) {
            console.log('Keydown event:', e.key);
            const sugerenciasDiv = document.getElementById('sugerencias');
            const items = sugerenciasDiv.querySelectorAll('.list-group-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                indiceSugerenciaSeleccionado = Math.min(indiceSugerenciaSeleccionado + 1, items.length - 1);
                actualizarSeleccionSugerencia(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                indiceSugerenciaSeleccionado = Math.max(indiceSugerenciaSeleccionado - 1, -1);
                actualizarSeleccionSugerencia(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (indiceSugerenciaSeleccionado >= 0 && items[indiceSugerenciaSeleccionado]) {
                    items[indiceSugerenciaSeleccionado].click();
                } else {
                    buscarRapida();
                }
            } else if (e.key === 'Escape') {
                sugerenciasDiv.style.display = 'none';
                indiceSugerenciaSeleccionado = -1;
            }
        });
        
        function actualizarSeleccionSugerencia(items) {
            items.forEach((item, index) => {
                if (index === indiceSugerenciaSeleccionado) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // Cerrar sugerencias al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#busquedaRapida') && !e.target.closest('#sugerencias')) {
                document.getElementById('sugerencias').style.display = 'none';
            }
        });
        
        // Inicialización
        console.log('Autocompletar inicializado');
    </script>
}
