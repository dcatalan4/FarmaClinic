@model ControlInventario.Models.Ventum
@using System.Security.Claims
@{
    ViewData["Title"] = "Nueva Venta";
}

<!-- Incluir DateTime Helper -->
<script src="~/js/datetime-helper.js"></script>

<!-- CSS para el modal de búsqueda de productos -->
<style>
    .modal-busqueda-producto {
        z-index: 1055 !important;
    }
    
    .modal-busqueda-producto .modal-dialog {
        max-width: 800px !important;
        margin: 1.75rem auto;
    }
    
    .modal-busqueda-producto .modal-content {
        background-color: white !important;
        border: 1px solid #dee2e6 !important;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .modal-busqueda-producto .modal-header {
        background-color: #f8f9fa !important;
        border-bottom: 1px solid #dee2e6 !important;
    }
    
    .modal-busqueda-producto .modal-body {
        background-color: white !important;
        color: #212529 !important;
    }
    
    .modal-busqueda-producto .modal-footer {
        background-color: #f8f9fa !important;
        border-top: 1px solid #dee2e6 !important;
    }
    
    /* Forzar que el backdrop no sea tan oscuro */
    .modal-backdrop.show {
        background-color: rgba(0, 0, 0, 0.3) !important;
    }
    
    .modal-busqueda-producto ~ .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.3) !important;
    }
    
    .producto-seleccionado {
        background-color: #e3f2fd !important;
        border-color: #2196f3 !important;
    }
    
    .producto-seleccionado:hover {
        background-color: #bbdefb !important;
    }
    
    .table-productos th {
        background-color: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .table-productos tbody tr {
        cursor: pointer;
    }
    
    .table-productos tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .badge-stock {
        font-size: 0.8em;
    }
    
    .stock-bajo {
        color: #dc3545;
        font-weight: bold;
    }
    
    .stock-medio {
        color: #ffc107;
        font-weight: bold;
    }
    
    .stock-alto {
        color: #28a745;
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <!-- Contenedor global para autocompletes fuera del flujo normal -->
    <div id="autocompleteContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2147483647;"></div>
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>¡Éxito!</strong> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    
    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>¡Advertencia!</strong> @TempData["Warning"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Nueva Venta</h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a la lista
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form asp-action="Create" id="ventaForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Información de la Venta</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Usuario</label>
                                    <div class="form-control-plaintext">
                                        <i class="fas fa-user-circle"></i> @User.Identity.Name
                                        <input type="hidden" name="IdUsuario" value="@User.FindFirst("IdUsuario")?.Value" />
                                    </div>
                                    <small class="text-muted">Usuario: @User.FindFirst("Usuario")?.Value | Rol: @User.FindFirst(ClaimTypes.Role)?.Value</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Fecha y Hora</label>
                                    <input type="text" class="form-control" id="fechaCliente" readonly />
                                    <small class="text-muted">Hora local de tu equipo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Productos</h6>
                        <div>
                            <button type="button" class="btn btn-info btn-sm mr-2" onclick="abrirModalInventario()">
                                <i class="fas fa-list"></i> Ver Inventario Completo
                            </button>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarProducto()">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="productosContainer" style="position: relative; padding-bottom: 250px;">
                            <div class="producto-row row mb-3" data-index="0">
                                <div class="col-md-5">
                                    <label class="control-label font-weight-bold">Producto</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control producto-busqueda" placeholder="Haga clic para buscar producto..." autocomplete="off" readonly />
                                        <input type="hidden" name="IdProducto[0]" class="producto-id" />
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Cantidad</label>
                                    <input type="number" name="Cantidad[0]" class="form-control cantidad-input" min="1" value="1" onchange="calcularSubtotal(0)" disabled />
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Precio Unitario</label>
                                    <input type="number" name="PrecioUnitario[0]" class="form-control precio-input" step="0.01" min="0" readonly />
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Subtotal</label>
                                    <input type="text" class="form-control subtotal-input" readonly />
                                </div>
                                <div class="col-md-1">
                                    <label>&nbsp;</label><br>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(0)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Resumen de Venta</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Subtotal</label>
                                    <input type="text" id="subtotalGeneral" class="form-control" value="Q 0.00" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Total</label>
                                    <input type="text" id="totalGeneral" class="form-control" value="Q 0.00" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Registrar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Información de Producto</h6>
                </div>
                <div class="card-body">
                    <div id="productoInfo" class="text-center text-muted">
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <p>Seleccione un producto para ver su información</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Búsqueda de Productos -->
<div class="modal fade modal-busqueda-producto" id="busquedaProductoModal" tabindex="-1" role="dialog" aria-labelledby="busquedaProductoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="busquedaProductoModalLabel">
                    <i class="fas fa-search"></i> Buscar Producto
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="text" id="busquedaModalInput" class="form-control" placeholder="Buscar por nombre, código o descripción...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" onclick="buscarEnModal()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="filtroStock" class="form-control">
                            <option value="">Todos los productos</option>
                            <option value="constock">Con stock</option>
                            <option value="sinstock">Sin stock</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover table-productos">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaResultados">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <p>Escriba para buscar productos</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let productoIndex = 1;
        let currentRowIndex = null; // Track which row is being edited

        function inicializarBuscador(index) {
            // Para cada campo de búsqueda, agregar evento click para abrir modal
            const buscador = document.querySelector(`[data-index="${index}"] .producto-busqueda`);
            if (buscador) {
                buscador.addEventListener('click', function() {
                    currentRowIndex = index;
                    abrirModalBusqueda();
                });
                
                // También permitir búsqueda con Enter
                buscador.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        currentRowIndex = index;
                        abrirModalBusqueda();
                    }
                });
            }
        }

        function abrirModalBusqueda() {
            // Limpiar búsqueda anterior
            document.getElementById('busquedaModalInput').value = '';
            document.getElementById('filtroStock').value = '';
            document.getElementById('tablaResultados').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        <i class="fas fa-search fa-2x mb-2"></i>
                        <p>Escriba para buscar productos</p>
                    </td>
                </tr>
            `;
            
            // Abrir modal usando JavaScript nativo
            const modal = document.getElementById('busquedaProductoModal');
            if (modal) {
                modal.style.display = 'block';
                modal.classList.add('show');
                modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                
                // Agregar backdrop manualmente si no existe
                let backdrop = document.querySelector('.modal-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.3)';
                    document.body.appendChild(backdrop);
                }
                
                // Poner foco en el campo de búsqueda
                setTimeout(() => {
                    document.getElementById('busquedaModalInput').focus();
                }, 300);
            }
        }

        function cerrarModalBusqueda() {
            const modal = document.getElementById('busquedaProductoModal');
            const backdrop = document.querySelector('.modal-backdrop');
            
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
            
            if (backdrop) {
                backdrop.remove();
            }
        }

        async function buscarEnModal() {
            const term = document.getElementById('busquedaModalInput').value.trim();
            const filtroStock = document.getElementById('filtroStock').value;
            const tablaResultados = document.getElementById('tablaResultados');
            
            if (term.length < 2) {
                tablaResultados.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>Escriba al menos 2 caracteres para buscar</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Mostrar loading
            tablaResultados.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Buscando...</span>
                        </div>
                        <p class="mt-2">Buscando productos...</p>
                    </td>
                </tr>
            `;
            
            try {
                let url = `/Venta/BuscarProductos?term=${encodeURIComponent(term)}`;
                if (filtroStock === 'constock') {
                    url += '&conStock=true';
                } else if (filtroStock === 'sinstock') {
                    url += '&conStock=false';
                }
                
                const response = await fetch(url);
                const productos = await response.json();
                
                if (productos.length === 0) {
                    tablaResultados.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                <p>No se encontraron productos</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                productos.forEach(producto => {
                    const stockClass = producto.stock <= 5 ? 'stock-bajo' : 
                                     producto.stock <= 20 ? 'stock-medio' : 'stock-alto';
                    const stockBadge = producto.stock > 0 ? 
                        `<span class="badge badge-success ${stockClass}">${producto.stock}</span>` :
                        `<span class="badge badge-danger">Sin stock</span>`;
                    
                    html += `
                        <tr onclick="seleccionarProductoModal(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}', ${producto.precioVenta}, ${producto.stock}, '${producto.codigo}')">
                            <td><strong>${producto.codigo}</strong></td>
                            <td>${producto.nombre}</td>
                            <td><small class="text-muted">${producto.descripcion || 'Sin descripción'}</small></td>
                            <td class="text-right"><strong>Q ${producto.precioVenta.toFixed(2)}</strong></td>
                            <td class="text-center">${stockBadge}</td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); seleccionarProductoModal(${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}', ${producto.precioVenta}, ${producto.stock}, '${producto.codigo}')">
                                    <i class="fas fa-check"></i> Seleccionar
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tablaResultados.innerHTML = html;
                
            } catch (error) {
                console.error('Error al buscar productos:', error);
                tablaResultados.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Error al buscar productos. Intente nuevamente.</p>
                        </td>
                    </tr>
                `;
            }
        }

        function seleccionarProductoModal(id, nombre, precio, stock, codigo) {
            if (currentRowIndex === null) return;
            
            const row = document.querySelector(`[data-index="${currentRowIndex}"]`);
            const buscador = row.querySelector('.producto-busqueda');
            const idInput = row.querySelector('.producto-id');
            const cantidadInput = row.querySelector('.cantidad-input');
            const precioInput = row.querySelector('.precio-input');
            
            buscador.value = nombre;
            idInput.value = id;
            precioInput.value = precio.toFixed(2);
            cantidadInput.disabled = false;
            cantidadInput.focus();
            
            // Cerrar modal usando función nativa
            cerrarModalBusqueda();
            
            // Calcular subtotal
            calcularSubtotal(currentRowIndex);
            
            // Reset current row index
            currentRowIndex = null;
        }

        // Event listener para buscar mientras se escribe en el modal
        document.addEventListener('DOMContentLoaded', function() {
            const busquedaInput = document.getElementById('busquedaModalInput');
            if (busquedaInput) {
                let searchTimeout;
                busquedaInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        buscarEnModal();
                    }, 300);
                });
                
                // Buscar con Enter
                busquedaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        buscarEnModal();
                    }
                });
            }
            
            // Event listener para cerrar modal con botón cancelar
            const cancelarBtn = document.querySelector('[data-dismiss="modal"]');
            if (cancelarBtn) {
                cancelarBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    cerrarModalBusqueda();
                });
            }
            
            // Event listener para cerrar modal al hacer clic en backdrop
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    cerrarModalBusqueda();
                }
            });
            
            // Event listener para cerrar modal con Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('busquedaProductoModal');
                    if (modal && modal.style.display === 'block') {
                        cerrarModalBusqueda();
                    }
                }
            });
            
            // Inicializar el primer buscador
            inicializarBuscador(0);
        });

        function agregarProducto() {
            const container = document.getElementById('productosContainer');
            const newRow = document.createElement('div');
            newRow.className = 'producto-row row mb-3';
            newRow.setAttribute('data-index', productoIndex);
            
            newRow.innerHTML = `
                <div class="col-md-5">
                    <label class="control-label font-weight-bold">Producto</label>
                    <div class="input-group">
                        <input type="text" class="form-control producto-busqueda" placeholder="Haga clic para buscar producto..." autocomplete="off" readonly />
                        <input type="hidden" name="IdProducto[${productoIndex}]" class="producto-id" />
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <input type="number" name="Cantidad[${productoIndex}]" class="form-control cantidad-input" min="1" value="1" onchange="calcularSubtotal(${productoIndex})" disabled />
                </div>
                <div class="col-md-2">
                    <input type="number" name="PrecioUnitario[${productoIndex}]" class="form-control precio-input" step="0.01" min="0" readonly />
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control subtotal-input" readonly />
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${productoIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            // Insertar la nueva fila al principio del contenedor
            if (container.firstChild) {
                container.insertBefore(newRow, container.firstChild);
            } else {
                container.appendChild(newRow);
            }
            
            // Agregar animación de entrada
            newRow.style.opacity = '0';
            newRow.style.transform = 'translateY(-20px)';
            newRow.style.transition = 'all 0.3s ease';
            
            // Forzar reflow y animar
            setTimeout(() => {
                newRow.style.opacity = '1';
                newRow.style.transform = 'translateY(0)';
            }, 10);
            
            // Inicializar el buscador con un pequeño delay para asegurar que el DOM esté listo
            setTimeout(() => {
                inicializarBuscador(productoIndex - 1);
            }, 50);
            
            productoIndex++;
            actualizarBotonesEliminar();
        }

        function eliminarProducto(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row) {
                row.remove();
                calcularTotales();
                actualizarBotonesEliminar();
            }
        }

        function actualizarBotonesEliminar() {
            const filas = document.querySelectorAll('.producto-row');
            filas.forEach((fila, index) => {
                const boton = fila.querySelector('.btn-danger');
                if (boton) {
                    boton.style.display = filas.length > 1 ? 'inline-block' : 'none';
                }
            });
        }

        function calcularSubtotal(index) {
            const cantidad = parseFloat(document.querySelector(`[data-index="${index}"] .cantidad-input`).value) || 0;
            const precio = parseFloat(document.querySelector(`[data-index="${index}"] .precio-input`).value) || 0;
            const subtotal = cantidad * precio;
            
            document.querySelector(`[data-index="${index}"] .subtotal-input`).value = `Q ${subtotal.toFixed(2)}`;
            calcularTotales();
        }

        function calcularTotales() {
            let subtotalGeneral = 0;
            
            document.querySelectorAll('.subtotal-input').forEach(input => {
                const valor = parseFloat(input.value.replace('Q ', '').replace(',', '')) || 0;
                subtotalGeneral += valor;
            });
            
            document.getElementById('subtotalGeneral').value = `Q ${subtotalGeneral.toFixed(2)}`;
            document.getElementById('totalGeneral').value = `Q ${subtotalGeneral.toFixed(2)}`;
        }

        // Validación del formulario
        document.getElementById('ventaForm').addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT DEBUG ===');
            
            // Agregar fecha y hora del cliente al formulario
            DateTimeClientHelper.addClientDateTimeToForm('ventaForm');
            
            const productosIds = document.querySelectorAll('.producto-id');
            let productosValidos = 0;
            let productosVacios = 0;
            
            console.log('Productos encontrados:', productosIds.length);
            
            productosIds.forEach((input, index) => {
                const productoId = input.value;
                const cantidad = document.querySelector(`[data-index="${index}"] .cantidad-input`).value;
                const precio = document.querySelector(`[data-index="${index}"] .precio-input`).value;
                
                console.log(`Producto ${index}: ID=${productoId}, Cantidad=${cantidad}, Precio=${precio}`);
                
                // Verificar si el producto está completo
                if (productoId && cantidad && precio && productoId !== '0' && parseFloat(cantidad) > 0 && parseFloat(precio) > 0) {
                    productosValidos++;
                } else if (productoId === '' || productoId === '0') {
                    productosVacios++;
                }
            });
            
            const usuarioSelect = document.getElementById('IdUsuario');
            console.log('Usuario seleccionado:', usuarioSelect.value);
            
            // Validar que haya al menos un producto completo
            if (productosValidos === 0) {
                e.preventDefault();
                if (productosVacios > 0) {
                    alert('Hay campos de producto vacíos. Por favor, complete los datos del producto o elimine los campos vacíos antes de registrar la venta.');
                } else {
                    alert('Debe agregar al menos un producto completo a la venta');
                }
                return;
            }
            
            // Alertar si hay campos vacíos pero hay productos válidos
            if (productosVacios > 0) {
                e.preventDefault();
                alert(`Hay ${productosVacios} campo(s) de producto vacío(s). Por favor, complete los datos o elimine los campos vacíos antes de continuar.`);
                return;
            }
            
            const usuario = usuarioSelect.value;
            if (!usuario) {
                e.preventDefault();
                alert('Debe seleccionar un usuario');
                return;
            }
            
            console.log('Formulario válido, enviando...');
        });

        // Inicializar el primer buscador cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            inicializarBuscador(0);
            
            // Inicializar fecha y hora del cliente
            if (typeof DateTimeClientHelper !== 'undefined') {
                document.getElementById('fechaCliente').value = DateTimeClientHelper.formatDateTime();
                console.log('Fecha del cliente inicializada:', DateTimeClientHelper.getClientDateTime());
            }
            
            // Auto-cerrar alerta de éxito después de 5 segundos
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.transition = 'opacity 0.5s';
                    successAlert.style.opacity = '0';
                    setTimeout(() => {
                        successAlert.remove();
                    }, 500);
                }, 5000);
                
                // Limpiar formulario después de venta exitosa
                limpiarFormulario();
            }
        });
        
        // Función para limpiar el formulario
        function limpiarFormulario() {
            // Limpiar campos de productos
            const productosContainer = document.getElementById('productosContainer');
            if (productosContainer) {
                productosContainer.innerHTML = `
                    <div class="producto-row" data-index="0">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="font-weight-bold">Producto</label>
                                    <div class="search-container">
                                        <input type="text" class="form-control producto-buscador" placeholder="Buscar producto..." autocomplete="off">
                                        <input type="hidden" class="producto-id" name="IdProducto[0]" value="0">
                                        <div class="search-results"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Cantidad</label>
                                    <input type="number" class="form-control cantidad-input" name="Cantidad[0]" value="1" min="1" onchange="calcularSubtotal(0)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Precio Unit.</label>
                                    <input type="text" class="form-control precio-input" name="PrecioUnitario[0]" value="Q 0.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Subtotal</label>
                                    <input type="text" class="form-control subtotal-input" value="Q 0.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label><br>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(0)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                productoIndex = 1;
                inicializarBuscador(0);
                calcularTotales();
            }
            
            // Resetear selección de usuario
            const usuarioSelect = document.getElementById('IdUsuario');
            if (usuarioSelect) {
                usuarioSelect.value = '';
            }
        }

        // Funciones para el modal de inventario
        function abrirModalInventario() {
            console.log('Abriendo modal de inventario...');
            const modal = document.getElementById('inventarioModal');
            if (modal) {
                // Usar Bootstrap Modal API directamente
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // Cargar inventario después de mostrar el modal
                setTimeout(() => {
                    cargarInventarioCompleto();
                }, 500);
            } else {
                console.error('No se encontró el modal del inventario');
                alert('Error: No se pudo abrir el modal de inventario');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para cuando el modal se muestra
            const inventarioModal = document.getElementById('inventarioModal');
            if (inventarioModal) {
                inventarioModal.addEventListener('shown.bs.modal', function () {
                    console.log('Modal mostrado, cargando inventario...');
                    cargarInventarioCompleto();
                });
            }
        });

        function cargarInventarioCompleto(termino = '') {
            const loadingInventario = document.getElementById('loadingInventario');
            const tablaInventario = document.getElementById('tablaInventario');
            const noResultados = document.getElementById('noResultados');
            
            if (loadingInventario) loadingInventario.style.display = 'block';
            if (tablaInventario) tablaInventario.style.display = 'none';
            if (noResultados) noResultados.style.display = 'none';

            const url = '@Url.Action("BuscarInventarioCompleto", "Venta")' + '?termino=' + encodeURIComponent(termino);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (loadingInventario) loadingInventario.style.display = 'none';
                    
                    if (data && data.length > 0) {
                        if (tablaInventario) tablaInventario.style.display = 'table';
                        const cuerpoInventario = document.getElementById('cuerpoInventario');
                        if (cuerpoInventario) {
                            cuerpoInventario.innerHTML = '';
                            
                            data.forEach(function (producto) {
                                const fila = document.createElement('tr');
                                fila.innerHTML = `
                                    <td>${producto.codigo || ''}</td>
                                    <td><strong>${producto.nombre}</strong></td>
                                    <td>${producto.descripcion || ''}</td>
                                    <td class="text-right">Q ${producto.precioVenta.toFixed(2)}</td>
                                    <td class="text-right">
                                        <strong>${producto.stockActual}</strong>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="agregarProductoDesdeInventario(${producto.idProducto}, '${(producto.nombre || '').replace(/'/g, "\\'")}', ${producto.precioVenta}, ${producto.stockActual})" ${producto.stockActual === 0 ? 'disabled' : ''}>
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </td>
                                `;
                                cuerpoInventario.appendChild(fila);
                            });
                        }
                    } else {
                        if (noResultados) noResultados.style.display = 'block';
                    }
                })
                .catch(error => {
                    if (loadingInventario) loadingInventario.style.display = 'none';
                    console.error('Error al cargar inventario:', error);
                    alert('Error al cargar el inventario. Por favor, intente nuevamente.');
                });
        }

        function buscarInventario() {
            const busquedaInput = document.getElementById('busquedaInventario');
            const termino = busquedaInput ? busquedaInput.value.trim() : '';
            cargarInventarioCompleto(termino);
        }

        function agregarProductoDesdeInventario(idProducto, nombre, precio, stock) {
            if (stock === 0) {
                alert('No hay stock disponible para este producto.');
                return;
            }

            // Encontrar el primer campo de producto vacío
            const productosIds = document.querySelectorAll('.producto-id');
            let agregado = false;
            
            productosIds.forEach(function(input, index) {
                if (!agregado && (input.value === '0' || input.value === '')) {
                    // Llenar el campo de producto
                    input.value = idProducto;
                    const row = input.closest('.producto-row');
                    if (row) {
                        const busquedaInput = row.querySelector('.producto-busqueda');
                        const cantidadInput = row.querySelector('.cantidad-input');
                        const precioInput = row.querySelector('.precio-input');
                        
                        if (busquedaInput) busquedaInput.value = nombre;
                        if (cantidadInput) {
                            cantidadInput.value = 1;
                            cantidadInput.disabled = false;
                        }
                        if (precioInput) precioInput.value = precio.toFixed(2);
                    }
                    
                    // Calcular subtotal
                    calcularSubtotal(index);
                    agregado = true;
                    
                    // Mostrar mensaje de éxito
                    mostrarToast('Producto Agregado', `${nombre} se ha agregado a la venta.`);
                }
            });

            if (!agregado) {
                // Si no hay campos vacíos, agregar uno nuevo
                agregarProducto();
                setTimeout(() => {
                    const lastIndex = productoIndex - 1;
                    const nuevoProductoId = document.querySelector(`.producto-id:nth-child(${lastIndex + 1})`);
                    const nuevoBusqueda = document.querySelectorAll('.producto-busqueda')[lastIndex];
                    const nuevaCantidad = document.querySelectorAll('.cantidad-input')[lastIndex];
                    const nuevoPrecio = document.querySelectorAll('.precio-input')[lastIndex];
                    
                    if (nuevoProductoId) nuevoProductoId.value = idProducto;
                    if (nuevoBusqueda) nuevoBusqueda.value = nombre;
                    if (nuevaCantidad) {
                        nuevaCantidad.value = 1;
                        nuevaCantidad.disabled = false;
                    }
                    if (nuevoPrecio) nuevoPrecio.value = precio.toFixed(2);
                    calcularSubtotal(lastIndex);
                }, 100);
            }

            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('inventarioModal'));
            if (modal) {
                modal.hide();
            }
            
            // Limpiar búsqueda
            const busquedaInput = document.getElementById('busquedaInventario');
            if (busquedaInput) busquedaInput.value = '';
        }

        function mostrarToast(titulo, mensaje) {
            const toastHtml = `
                <div class="position-fixed top-0 right-0 p-3" style="z-index: 1050; top: 20px; right: 20px;">
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-success text-white">
                            <i class="fas fa-check-circle mr-2"></i>
                            <strong class="mr-auto">${titulo}</strong>
                            <button type="button" class="ml-2 mb-1 close" onclick="this.closest('.position-fixed').remove()">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="toast-body">
                            ${mensaje}
                        </div>
                    </div>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.innerHTML = toastHtml;
            document.body.appendChild(toastContainer.firstElementChild);
            
            setTimeout(() => {
                const toast = document.querySelector('.position-fixed .toast');
                if (toast) {
                    toast.closest('.position-fixed').remove();
                }
            }, 3000);
        }

        // Permitir búsqueda con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const busquedaInput = document.getElementById('busquedaInventario');
            if (busquedaInput) {
                busquedaInput.addEventListener('keypress', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        buscarInventario();
                    }
                });
            }
        });
    </script>
}

<style>
    .card {
        border: 1px solid #e9ecef;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    .form-group label {
        color: #495057;
        margin-bottom: 0.25rem;
    }
    .producto-row {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
    }
    .producto-row:last-child {
        border-bottom: none;
    }
    .list-group {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .list-group-item {
        border: none;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }
    .list-group-item:last-child {
        border-bottom: none;
    }
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    .producto-busqueda {
        border-radius: 0.25rem 0 0 0.25rem;
    }
    .input-group-text {
        background-color: #f8f9fa;
        border-color: #ced4da;
    }
</style>

<!-- Modal de Inventario Completo -->
<div class="modal fade" id="inventarioModal" tabindex="-1" role="dialog" aria-labelledby="inventarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventarioModalLabel">
                    <i class="fas fa-warehouse"></i> Inventario Completo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <!-- Barra de búsqueda avanzada -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="input-group">
                            <input type="text" id="busquedaInventario" class="form-control" placeholder="Buscar por código, nombre o descripción...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" onclick="buscarInventario()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de inventario -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaInventario">
                        <thead class="thead-dark">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Precio Venta</th>
                                <th>Stock Actual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoInventario">
                            <!-- Los productos se cargarán aquí vía AJAX -->
                        </tbody>
                    </table>
                </div>

                <!-- Indicador de carga -->
                <div id="loadingInventario" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p>Cargando inventario...</p>
                </div>

                <!-- Mensaje de no resultados -->
                <div id="noResultados" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> No se encontraron productos que coincidan con la búsqueda.
                </div>
            </div>
        </div>
    </div>
</div>
