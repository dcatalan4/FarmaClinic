@model ControlInventario.Models.Ventum
@using System.Security.Claims
@{
    ViewData["Title"] = "Nueva Venta";
}

<!-- Incluir DateTime Helper -->
<script src="~/js/datetime-helper.js"></script>

<div class="container-fluid">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>¡Éxito!</strong> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    
    @if (TempData["Warning"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>¡Advertencia!</strong> @TempData["Warning"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Nueva Venta</h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a la lista
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form asp-action="Create" id="ventaForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Información de la Venta</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Usuario</label>
                                    <div class="form-control-plaintext">
                                        <i class="fas fa-user-circle"></i> @User.Identity.Name
                                        <input type="hidden" name="IdUsuario" value="@User.FindFirst("IdUsuario")?.Value" />
                                    </div>
                                    <small class="text-muted">Usuario: @User.FindFirst("Usuario")?.Value | Rol: @User.FindFirst(ClaimTypes.Role)?.Value</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Fecha y Hora</label>
                                    <input type="text" class="form-control" id="fechaCliente" readonly />
                                    <small class="text-muted">Hora local de tu equipo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Productos</h6>
                        <div>
                            <button type="button" class="btn btn-info btn-sm mr-2" onclick="abrirModalInventario()">
                                <i class="fas fa-list"></i> Ver Inventario Completo
                            </button>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarProducto()">
                                <i class="fas fa-plus"></i> Agregar Producto
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="productosContainer">
                            <div class="producto-row row mb-3" data-index="0">
                                <div class="col-md-5">
                                    <label class="control-label font-weight-bold">Producto</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control producto-busqueda" placeholder="Buscar por nombre o descripción..." autocomplete="off" />
                                        <input type="hidden" name="IdProducto[0]" class="producto-id" />
                                        <div class="input-group-append">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        </div>
                                    </div>
                                    <div class="producto-resultados mt-1" style="position: relative; z-index: 1000;"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Cantidad</label>
                                    <input type="number" name="Cantidad[0]" class="form-control cantidad-input" min="1" value="1" onchange="calcularSubtotal(0)" disabled />
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Precio Unitario</label>
                                    <input type="number" name="PrecioUnitario[0]" class="form-control precio-input" step="0.01" min="0" readonly />
                                </div>
                                <div class="col-md-2">
                                    <label class="control-label font-weight-bold">Subtotal</label>
                                    <input type="text" class="form-control subtotal-input" readonly />
                                </div>
                                <div class="col-md-1">
                                    <label>&nbsp;</label><br>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(0)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Resumen de Venta</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Subtotal</label>
                                    <input type="text" id="subtotalGeneral" class="form-control" value="Q 0.00" readonly />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label font-weight-bold">Total</label>
                                    <input type="text" id="totalGeneral" class="form-control" value="Q 0.00" readonly />
                                </div>
                            </div>
                        </div>
                        <div class="form-group text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Registrar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Información de Producto</h6>
                </div>
                <div class="card-body">
                    <div id="productoInfo" class="text-center text-muted">
                        <i class="fas fa-box fa-3x mb-3"></i>
                        <p>Seleccione un producto para ver su información</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let productoIndex = 1;
        let searchTimeout;

        function inicializarBuscador(index) {
            const buscador = document.querySelector(`[data-index="${index}"] .producto-busqueda`);
            const resultadosDiv = document.querySelector(`[data-index="${index}"] .producto-resultados`);
            
            if (!buscador) return;

            buscador.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const term = this.value.trim();
                
                if (term.length < 2) {
                    resultadosDiv.innerHTML = '';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    buscarProductos(term, index);
                }, 300);
            });

            buscador.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    buscarProductos(this.value.trim(), index);
                }
            });

            document.addEventListener('click', function(e) {
                if (!buscador.contains(e.target) && !resultadosDiv.contains(e.target)) {
                    resultadosDiv.innerHTML = '';
                }
            });
        }

        async function buscarProductos(term, index) {
            try {
                const response = await fetch(`/Venta/BuscarProductos?term=${encodeURIComponent(term)}`);
                const productos = await response.json();
                
                const resultadosDiv = document.querySelector(`[data-index="${index}"] .producto-resultados`);
                
                if (productos.length > 0) {
                    let html = '<div class="list-group" style="position: absolute; width: 100%; max-height: 200px; overflow-y: auto;">';
                    
                    productos.forEach(producto => {
                        html += `
                            <a href="#" class="list-group-item list-group-item-action" onclick="seleccionarProducto(${index}, ${producto.id}, '${producto.nombre.replace(/'/g, "\\'")}', ${producto.precioVenta}, ${producto.stock}, '${producto.codigo}')">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${producto.nombre}</h6>
                                    <small class="text-muted">Q ${producto.precioVenta.toFixed(2)}</small>
                                </div>
                                <p class="mb-1 text-muted small">${producto.descripcion || 'Sin descripción'}</p>
                                <small class="text-muted">Código: ${producto.codigo} | Stock: ${producto.stock}</small>
                            </a>
                        `;
                    });
                    
                    html += '</div>';
                    resultadosDiv.innerHTML = html;
                } else {
                    resultadosDiv.innerHTML = '<div class="alert alert-info py-2">No se encontraron productos</div>';
                }
            } catch (error) {
                console.error('Error al buscar productos:', error);
            }
        }

        function seleccionarProducto(index, id, nombre, precio, stock, codigo) {
            const row = document.querySelector(`[data-index="${index}"]`);
            const buscador = row.querySelector('.producto-busqueda');
            const idInput = row.querySelector('.producto-id');
            const cantidadInput = row.querySelector('.cantidad-input');
            const precioInput = row.querySelector('.precio-input');
            const resultadosDiv = row.querySelector('.producto-resultados');
            
            buscador.value = nombre;
            idInput.value = id;
            precioInput.value = precio;
            cantidadInput.max = stock;
            cantidadInput.disabled = false;
            
            resultadosDiv.innerHTML = '';
            
            // Mostrar información del producto
            document.getElementById('productoInfo').innerHTML = `
                <div class="text-left">
                    <p><strong>Código:</strong> ${codigo}</p>
                    <p><strong>Nombre:</strong> ${nombre}</p>
                    <p><strong>Precio:</strong> Q ${precio.toFixed(2)}</p>
                    <p><strong>Stock disponible:</strong> ${stock}</p>
                </div>
            `;
            
            calcularSubtotal(index);
        }

        function agregarProducto() {
            const container = document.getElementById('productosContainer');
            const newRow = document.createElement('div');
            newRow.className = 'producto-row row mb-3';
            newRow.setAttribute('data-index', productoIndex);
            
            newRow.innerHTML = `
                <div class="col-md-5">
                    <div class="input-group">
                        <input type="text" class="form-control producto-busqueda" placeholder="Buscar por nombre o descripción..." autocomplete="off" />
                        <input type="hidden" name="IdProducto[${productoIndex}]" class="producto-id" />
                        <div class="input-group-append">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                    <div class="producto-resultados mt-1" style="position: relative; z-index: 1000;"></div>
                </div>
                <div class="col-md-2">
                    <input type="number" name="Cantidad[${productoIndex}]" class="form-control cantidad-input" min="1" value="1" onchange="calcularSubtotal(${productoIndex})" disabled />
                </div>
                <div class="col-md-2">
                    <input type="number" name="PrecioUnitario[${productoIndex}]" class="form-control precio-input" step="0.01" min="0" readonly />
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control subtotal-input" readonly />
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${productoIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(newRow);
            productoIndex++;
            actualizarBotonesEliminar();
            inicializarBuscador(productoIndex - 1);
        }

        function eliminarProducto(index) {
            const row = document.querySelector(`[data-index="${index}"]`);
            if (row) {
                row.remove();
                calcularTotales();
                actualizarBotonesEliminar();
            }
        }

        function actualizarBotonesEliminar() {
            const filas = document.querySelectorAll('.producto-row');
            filas.forEach((fila, index) => {
                const boton = fila.querySelector('.btn-danger');
                if (boton) {
                    boton.style.display = filas.length > 1 ? 'inline-block' : 'none';
                }
            });
        }

        function calcularSubtotal(index) {
            const cantidad = parseFloat(document.querySelector(`[data-index="${index}"] .cantidad-input`).value) || 0;
            const precio = parseFloat(document.querySelector(`[data-index="${index}"] .precio-input`).value) || 0;
            const subtotal = cantidad * precio;
            
            document.querySelector(`[data-index="${index}"] .subtotal-input`).value = `Q ${subtotal.toFixed(2)}`;
            calcularTotales();
        }

        function calcularTotales() {
            let subtotalGeneral = 0;
            
            document.querySelectorAll('.subtotal-input').forEach(input => {
                const valor = parseFloat(input.value.replace('Q ', '').replace(',', '')) || 0;
                subtotalGeneral += valor;
            });
            
            document.getElementById('subtotalGeneral').value = `Q ${subtotalGeneral.toFixed(2)}`;
            document.getElementById('totalGeneral').value = `Q ${subtotalGeneral.toFixed(2)}`;
        }

        // Validación del formulario
        document.getElementById('ventaForm').addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT DEBUG ===');
            
            // Agregar fecha y hora del cliente al formulario
            DateTimeClientHelper.addClientDateTimeToForm('ventaForm');
            
            const productosIds = document.querySelectorAll('.producto-id');
            let productosValidos = 0;
            let productosVacios = 0;
            
            console.log('Productos encontrados:', productosIds.length);
            
            productosIds.forEach((input, index) => {
                const productoId = input.value;
                const cantidad = document.querySelector(`[data-index="${index}"] .cantidad-input`).value;
                const precio = document.querySelector(`[data-index="${index}"] .precio-input`).value;
                
                console.log(`Producto ${index}: ID=${productoId}, Cantidad=${cantidad}, Precio=${precio}`);
                
                // Verificar si el producto está completo
                if (productoId && cantidad && precio && productoId !== '0' && parseFloat(cantidad) > 0 && parseFloat(precio) > 0) {
                    productosValidos++;
                } else if (productoId === '' || productoId === '0') {
                    productosVacios++;
                }
            });
            
            const usuarioSelect = document.getElementById('IdUsuario');
            console.log('Usuario seleccionado:', usuarioSelect.value);
            
            // Validar que haya al menos un producto completo
            if (productosValidos === 0) {
                e.preventDefault();
                if (productosVacios > 0) {
                    alert('Hay campos de producto vacíos. Por favor, complete los datos del producto o elimine los campos vacíos antes de registrar la venta.');
                } else {
                    alert('Debe agregar al menos un producto completo a la venta');
                }
                return;
            }
            
            // Alertar si hay campos vacíos pero hay productos válidos
            if (productosVacios > 0) {
                e.preventDefault();
                alert(`Hay ${productosVacios} campo(s) de producto vacío(s). Por favor, complete los datos o elimine los campos vacíos antes de continuar.`);
                return;
            }
            
            const usuario = usuarioSelect.value;
            if (!usuario) {
                e.preventDefault();
                alert('Debe seleccionar un usuario');
                return;
            }
            
            console.log('Formulario válido, enviando...');
        });

        // Inicializar el primer buscador cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            inicializarBuscador(0);
            
            // Inicializar fecha y hora del cliente
            if (typeof DateTimeClientHelper !== 'undefined') {
                document.getElementById('fechaCliente').value = DateTimeClientHelper.formatDateTime();
                console.log('Fecha del cliente inicializada:', DateTimeClientHelper.getClientDateTime());
            }
            
            // Auto-cerrar alerta de éxito después de 5 segundos
            const successAlert = document.querySelector('.alert-success');
            if (successAlert) {
                setTimeout(() => {
                    successAlert.style.transition = 'opacity 0.5s';
                    successAlert.style.opacity = '0';
                    setTimeout(() => {
                        successAlert.remove();
                    }, 500);
                }, 5000);
                
                // Limpiar formulario después de venta exitosa
                limpiarFormulario();
            }
        });
        
        // Función para limpiar el formulario
        function limpiarFormulario() {
            // Limpiar campos de productos
            const productosContainer = document.getElementById('productosContainer');
            if (productosContainer) {
                productosContainer.innerHTML = `
                    <div class="producto-row" data-index="0">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="font-weight-bold">Producto</label>
                                    <div class="search-container">
                                        <input type="text" class="form-control producto-buscador" placeholder="Buscar producto..." autocomplete="off">
                                        <input type="hidden" class="producto-id" name="IdProducto[0]" value="0">
                                        <div class="search-results"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Cantidad</label>
                                    <input type="number" class="form-control cantidad-input" name="Cantidad[0]" value="1" min="1" onchange="calcularSubtotal(0)">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Precio Unit.</label>
                                    <input type="text" class="form-control precio-input" name="PrecioUnitario[0]" value="Q 0.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="font-weight-bold">Subtotal</label>
                                    <input type="text" class="form-control subtotal-input" value="Q 0.00" readonly>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label><br>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(0)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                productoIndex = 1;
                inicializarBuscador(0);
                calcularTotales();
            }
            
            // Resetear selección de usuario
            const usuarioSelect = document.getElementById('IdUsuario');
            if (usuarioSelect) {
                usuarioSelect.value = '';
            }
        }

        // Funciones para el modal de inventario
        function abrirModalInventario() {
            console.log('Abriendo modal de inventario...');
            const modal = document.getElementById('inventarioModal');
            if (modal) {
                // Usar Bootstrap Modal API directamente
                const bootstrapModal = new bootstrap.Modal(modal);
                bootstrapModal.show();
                
                // Cargar inventario después de mostrar el modal
                setTimeout(() => {
                    cargarInventarioCompleto();
                }, 500);
            } else {
                console.error('No se encontró el modal del inventario');
                alert('Error: No se pudo abrir el modal de inventario');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Event listener para cuando el modal se muestra
            const inventarioModal = document.getElementById('inventarioModal');
            if (inventarioModal) {
                inventarioModal.addEventListener('shown.bs.modal', function () {
                    console.log('Modal mostrado, cargando inventario...');
                    cargarInventarioCompleto();
                });
            }
        });

        function cargarInventarioCompleto(termino = '') {
            const loadingInventario = document.getElementById('loadingInventario');
            const tablaInventario = document.getElementById('tablaInventario');
            const noResultados = document.getElementById('noResultados');
            
            if (loadingInventario) loadingInventario.style.display = 'block';
            if (tablaInventario) tablaInventario.style.display = 'none';
            if (noResultados) noResultados.style.display = 'none';

            const url = '@Url.Action("BuscarInventarioCompleto", "Venta")' + '?termino=' + encodeURIComponent(termino);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (loadingInventario) loadingInventario.style.display = 'none';
                    
                    if (data && data.length > 0) {
                        if (tablaInventario) tablaInventario.style.display = 'table';
                        const cuerpoInventario = document.getElementById('cuerpoInventario');
                        if (cuerpoInventario) {
                            cuerpoInventario.innerHTML = '';
                            
                            data.forEach(function (producto) {
                                const fila = document.createElement('tr');
                                fila.innerHTML = `
                                    <td>${producto.codigo || ''}</td>
                                    <td><strong>${producto.nombre}</strong></td>
                                    <td>${producto.descripcion || ''}</td>
                                    <td class="text-right">Q ${producto.precioVenta.toFixed(2)}</td>
                                    <td class="text-right">
                                        <strong>${producto.stockActual}</strong>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="agregarProductoDesdeInventario(${producto.idProducto}, '${(producto.nombre || '').replace(/'/g, "\\'")}', ${producto.precioVenta}, ${producto.stockActual})" ${producto.stockActual === 0 ? 'disabled' : ''}>
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </td>
                                `;
                                cuerpoInventario.appendChild(fila);
                            });
                        }
                    } else {
                        if (noResultados) noResultados.style.display = 'block';
                    }
                })
                .catch(error => {
                    if (loadingInventario) loadingInventario.style.display = 'none';
                    console.error('Error al cargar inventario:', error);
                    alert('Error al cargar el inventario. Por favor, intente nuevamente.');
                });
        }

        function buscarInventario() {
            const busquedaInput = document.getElementById('busquedaInventario');
            const termino = busquedaInput ? busquedaInput.value.trim() : '';
            cargarInventarioCompleto(termino);
        }

        function agregarProductoDesdeInventario(idProducto, nombre, precio, stock) {
            if (stock === 0) {
                alert('No hay stock disponible para este producto.');
                return;
            }

            // Encontrar el primer campo de producto vacío
            const productosIds = document.querySelectorAll('.producto-id');
            let agregado = false;
            
            productosIds.forEach(function(input, index) {
                if (!agregado && (input.value === '0' || input.value === '')) {
                    // Llenar el campo de producto
                    input.value = idProducto;
                    const row = input.closest('.producto-row');
                    if (row) {
                        const busquedaInput = row.querySelector('.producto-busqueda');
                        const cantidadInput = row.querySelector('.cantidad-input');
                        const precioInput = row.querySelector('.precio-input');
                        
                        if (busquedaInput) busquedaInput.value = nombre;
                        if (cantidadInput) {
                            cantidadInput.value = 1;
                            cantidadInput.disabled = false;
                        }
                        if (precioInput) precioInput.value = precio.toFixed(2);
                    }
                    
                    // Calcular subtotal
                    calcularSubtotal(index);
                    agregado = true;
                    
                    // Mostrar mensaje de éxito
                    mostrarToast('Producto Agregado', `${nombre} se ha agregado a la venta.`);
                }
            });

            if (!agregado) {
                // Si no hay campos vacíos, agregar uno nuevo
                agregarProducto();
                setTimeout(() => {
                    const lastIndex = productoIndex - 1;
                    const nuevoProductoId = document.querySelector(`.producto-id:nth-child(${lastIndex + 1})`);
                    const nuevoBusqueda = document.querySelectorAll('.producto-busqueda')[lastIndex];
                    const nuevaCantidad = document.querySelectorAll('.cantidad-input')[lastIndex];
                    const nuevoPrecio = document.querySelectorAll('.precio-input')[lastIndex];
                    
                    if (nuevoProductoId) nuevoProductoId.value = idProducto;
                    if (nuevoBusqueda) nuevoBusqueda.value = nombre;
                    if (nuevaCantidad) {
                        nuevaCantidad.value = 1;
                        nuevaCantidad.disabled = false;
                    }
                    if (nuevoPrecio) nuevoPrecio.value = precio.toFixed(2);
                    calcularSubtotal(lastIndex);
                }, 100);
            }

            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('inventarioModal'));
            if (modal) {
                modal.hide();
            }
            
            // Limpiar búsqueda
            const busquedaInput = document.getElementById('busquedaInventario');
            if (busquedaInput) busquedaInput.value = '';
        }

        function mostrarToast(titulo, mensaje) {
            const toastHtml = `
                <div class="position-fixed top-0 right-0 p-3" style="z-index: 1050; top: 20px; right: 20px;">
                    <div class="toast show" role="alert">
                        <div class="toast-header bg-success text-white">
                            <i class="fas fa-check-circle mr-2"></i>
                            <strong class="mr-auto">${titulo}</strong>
                            <button type="button" class="ml-2 mb-1 close" onclick="this.closest('.position-fixed').remove()">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="toast-body">
                            ${mensaje}
                        </div>
                    </div>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.innerHTML = toastHtml;
            document.body.appendChild(toastContainer.firstElementChild);
            
            setTimeout(() => {
                const toast = document.querySelector('.position-fixed .toast');
                if (toast) {
                    toast.closest('.position-fixed').remove();
                }
            }, 3000);
        }

        // Permitir búsqueda con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const busquedaInput = document.getElementById('busquedaInventario');
            if (busquedaInput) {
                busquedaInput.addEventListener('keypress', function (e) {
                    if (e.which === 13) {
                        e.preventDefault();
                        buscarInventario();
                    }
                });
            }
        });
    </script>
}

<style>
    .card {
        border: 1px solid #e9ecef;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    .form-group label {
        color: #495057;
        margin-bottom: 0.25rem;
    }
    .producto-row {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
    }
    .producto-row:last-child {
        border-bottom: none;
    }
    .list-group {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .list-group-item {
        border: none;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }
    .list-group-item:last-child {
        border-bottom: none;
    }
    .list-group-item:hover {
        background-color: #f8f9fa;
    }
    .producto-busqueda {
        border-radius: 0.25rem 0 0 0.25rem;
    }
    .input-group-text {
        background-color: #f8f9fa;
        border-color: #ced4da;
    }
</style>

<!-- Modal de Inventario Completo -->
<div class="modal fade" id="inventarioModal" tabindex="-1" role="dialog" aria-labelledby="inventarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="inventarioModalLabel">
                    <i class="fas fa-warehouse"></i> Inventario Completo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body">
                <!-- Barra de búsqueda avanzada -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="input-group">
                            <input type="text" id="busquedaInventario" class="form-control" placeholder="Buscar por código, nombre o descripción...">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" onclick="buscarInventario()">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de inventario -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaInventario">
                        <thead class="thead-dark">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th>Precio Venta</th>
                                <th>Stock Actual</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoInventario">
                            <!-- Los productos se cargarán aquí vía AJAX -->
                        </tbody>
                    </table>
                </div>

                <!-- Indicador de carga -->
                <div id="loadingInventario" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p>Cargando inventario...</p>
                </div>

                <!-- Mensaje de no resultados -->
                <div id="noResultados" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> No se encontraron productos que coincidan con la búsqueda.
                </div>
            </div>
        </div>
    </div>
</div>
